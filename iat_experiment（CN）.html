<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>jsPsych IAT å®éªŒï¼ˆä¸­å›½ç‰ˆï¼‰</title>
    
    <!-- å¼•å…¥ jsPsych åŠç›¸å…³æ’ä»¶ -->
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-iat-html"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>

    <!-- XLSX è§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <!-- CSS æ ·å¼ä¼˜åŒ– -->
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f9f9f9;
        }
        .instructions {
            font-size: 22px;
            margin-bottom: 20px;
        }
        .category-label {
            font-size: 24px;
            font-weight: bold;
        }
        .stimulus {
            font-size: 32px;
            color: black;
        }
        .feedback-correct {
            font-size: 50px;
            color: green;
            font-weight: bold;
        }
        .feedback-wrong {
            font-size: 50px;
            color: red;
            font-weight: bold;
        }
        /* âœ… ç»Ÿä¸€å›¾ç‰‡å¤§å°ï¼Œç¡®ä¿æ‰€æœ‰å›¾ç‰‡éƒ½ä¸€è‡´ */
        img {
            width: 200px !important;
            height: 200px !important;
            object-fit: contain;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <h1>æ­£åœ¨åŠ è½½å®éªŒæ•°æ®ï¼Œè¯·ç¨å€™...</h1>

    <script>
        const participantID = prompt("è¯·è¾“å…¥æ‚¨çš„ç¼–å·æˆ–å§“åï¼ˆç”¨äºæ•°æ®å­˜å‚¨ï¼‰:");
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `IAT_${participantID}_${timestamp}.csv`;

        const jsPsych = initJsPsych({
            on_finish: function() {
                const data = jsPsych.data.get().filter({ trial_type: 'iat-html' });

                const correct_trials = data.filter({ correct: true }).count();
                const total_trials = data.count();
                const accuracy = Math.round((correct_trials / total_trials) * 100);
                const mean_rt = Math.round(data.filter({ correct: true }).select('rt').mean());

                document.body.innerHTML = `
                    <h2>å®éªŒç»“æœ</h2>
                    <p>æ­£ç¡®ç‡: <strong>${accuracy}%</strong></p>
                    <p>å¹³å‡ååº”æ—¶: <strong>${mean_rt} æ¯«ç§’</strong></p>
                    <p>æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ° CSV æ–‡ä»¶</p>
                `;

                const clean_data = data.filterColumns(['stage', 'stimulus', 'response', 'correct', 'rt']);
                clean_data.localSave('csv', filename);
            }
        });

        function loadExcelAndRunExperiment() {
            fetch("conditions_CN1.xlsx")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP é”™è¯¯ï¼çŠ¶æ€ç : ${response.status}`);
                    }
                    console.log("ğŸ“¥ Excel æ–‡ä»¶æˆåŠŸåŠ è½½");
                    return response.arrayBuffer();
                })
                .then(data => {
                    console.log("ğŸ” å¼€å§‹è§£æ Excel æ•°æ®");
                    const workbook = XLSX.read(new Uint8Array(data), { type: "array" });
                    console.log("ğŸ“„ Sheet åç§°:", workbook.SheetNames);
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    console.log("âœ… è§£ææˆåŠŸï¼Œæ•°æ®:", jsonData);
                    setupAndRunExperiment(jsonData);
                })
                .catch(error => {
                    document.body.innerHTML = `<h2>å®éªŒæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„</h2>`;
                    console.error("åŠ è½½ Excel å‡ºé”™:", error);
                });
        }

        function setupAndRunExperiment(jsonData) {
            let timeline = [];

            // âœ… è®¾å®šä¸åŒå®éªŒé˜¶æ®µçš„æŒ‰é”®è§„åˆ™
            const category_labels = {
                "å†…ç¾¤ä½“ç»ƒä¹ ": { left: ["ä¸­å›½", "ç§¯æ"], right: ["æ¶ˆæ"] },
                "å†…ç¾¤ä½“æµ‹è¯•": { left: ["ä¸­å›½", "ç§¯æ"], right: ["æ¶ˆæ"] },
                "å†…ç¾¤ä½“åè½¬ç»ƒä¹ ": { left: ["ç§¯æ"], right: ["ä¸­å›½", "æ¶ˆæ"] },
                "å†…ç¾¤ä½“åè½¬æµ‹è¯•": { left: ["ç§¯æ"], right: ["ä¸­å›½", "æ¶ˆæ"] },
                "å¤–ç¾¤ä½“ç»ƒä¹ ": { left: ["ç¾å›½", "ç§¯æ"], right: ["æ¶ˆæ"] },
                "å¤–ç¾¤ä½“æµ‹è¯•": { left: ["ç¾å›½", "ç§¯æ"], right: ["æ¶ˆæ"] },
                "å¤–ç¾¤ä½“åè½¬ç»ƒä¹ ": { left: ["ç§¯æ"], right: ["ç¾å›½", "æ¶ˆæ"] },
                "å¤–ç¾¤ä½“åè½¬æµ‹è¯•": { left: ["ç§¯æ"], right: ["ç¾å›½", "æ¶ˆæ"] }
            };

            const practiceStages = ["å†…ç¾¤ä½“ç»ƒä¹ ", "å†…ç¾¤ä½“åè½¬ç»ƒä¹ ", "å¤–ç¾¤ä½“ç»ƒä¹ ", "å¤–ç¾¤ä½“åè½¬ç»ƒä¹ "];
            const stages = [...new Set(jsonData.map(trial => trial.stage))];

            for (let stage of stages) {
                const stage_trials = jsonData.filter(trial => trial.stage === stage);
                const leftLabel = category_labels[stage]?.left.join(" + ") || "æœªçŸ¥";
                const rightLabel = category_labels[stage]?.right.join(" + ") || "æœªçŸ¥";

                timeline.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `
                        <h2>${stage}</h2>
                        <p>æŒ‰ <strong>F</strong> é€‰æ‹©å·¦ä¾§ç±»åˆ«: <strong>${leftLabel}</strong></p>
                        <p>æŒ‰ <strong>J</strong> é€‰æ‹©å³ä¾§ç±»åˆ«: <strong>${rightLabel}</strong></p>
                        <p>æŒ‰ "ç©ºæ ¼" ç»§ç»­</p>
                    `,
                    choices: [" "]
                });

                stage_trials.forEach(trial => {
                    let stimulus = "";
                    if (trial.imagePath?.trim()) {
                        stimulus += `<img src="./images/${trial.imagePath}" width="200" height="200"><br>`;
                    }
                    if (trial.word?.trim()) {
                        stimulus += `<span class="stimulus">${trial.word}</span>`;
                    }

                    const correctKey = category_labels[stage]?.left.includes(trial.category) ? "f" : "j";

                    const mainTrial = {
                        type: jsPsychIatHtml,
                        stimulus: stimulus,
                        stim_key_association: correctKey === "f" ? "left" : "right",
                        left_category_label: [`<span class="category-label">${leftLabel}</span>`],
                        right_category_label: [`<span class="category-label">${rightLabel}</span>`],
                        left_category_key: 'f',
                        right_category_key: 'j',
                        bottom_instructions: `<p class="instructions">æŒ‰ <strong>F</strong> é€‰æ‹©å·¦ä¾§ï¼ŒæŒ‰ <strong>J</strong> é€‰æ‹©å³ä¾§</p>`,
                        trial_duration: 3000,
                        force_correct_key_press: true,
                        data: { correct_response: correctKey }
                    };

                    timeline.push(mainTrial);

                    if (practiceStages.includes(stage)) {
                        timeline.push({
                            type: jsPsychHtmlKeyboardResponse,
                            stimulus: function() {
                                const lastTrial = jsPsych.data.getLastTrialData().values()[0];
                                return lastTrial.response === lastTrial.correct_response ? 
                                    '<span class="feedback-correct">âœ”</span>' : 
                                    '<span class="feedback-wrong">âœ—</span>';
                            },
                            trial_duration: 500,
                            choices: "NO_KEYS"
                        });
                    }
                });
            }

            jsPsych.run(timeline);
        }

        loadExcelAndRunExperiment();
    </script>
</body>
</html>